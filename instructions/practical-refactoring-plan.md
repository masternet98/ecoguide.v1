# 1인 개발자를 위한 실용적 리팩토링 계획

## 🎯 핵심 원칙
- **안전성 최우선**: 모든 변경 전후 프로그램 정상 동작 확인
- **점진적 개선**: 한 번에 하나씩, 작은 단위로 변경
- **실용성 중심**: 이론적 완벽함보다는 유지보수 가능한 코드
- **롤백 가능**: 언제든 이전 상태로 되돌릴 수 있도록 백업

---

## 📊 현상 분석 (2025-09-21 기준)

### 🔴 즉시 해결 필요
- `district_service.py`: 2,217줄 (단일 파일 너무 비대)
- `monitoring_ui.py`: 1,129줄 (UI와 로직 강결합)
- `notification_service.py`: 972줄 (알림 기능 과도하게 복잡)
- `prompt_service.py`: 842줄 (프롬프트 관리 복잡)

### 🟡 점진적 개선 필요
- `src/core/` 18개 파일의 복잡한 의존성 주입 구조
- 테스트 커버리지 부족 (`qdrant_test.py` 빈 파일)
- 설정 파일 분산 및 중복

### ✅ 현재 양호한 상태
- 엔트리 포인트 문제 없음 (`app_new.py` 존재하지 않음)
- 기본 아키텍처 구조는 양호
- 컴포넌트 기반 설계 잘 되어 있음

---

## 🗓️ 4주 안전한 리팩토링 계획

### 🚨 1주차: 생존 - 거대 파일 분해
**목표**: 단일 파일 최대 500줄 이하로 제한

#### 1-1단계: district_service.py 분해 (2,217줄 → 4개 파일)
- [ ] 백업 생성: `district_service.py.backup`
- [ ] 분해 계획 수립
- [ ] `district_loader.py` (데이터 로딩 기능)
- [ ] `district_cache.py` (캐시 관리 기능)
- [ ] `district_validator.py` (데이터 검증 기능)
- [ ] `district_api.py` (API 인터페이스)
- [ ] 테스트: 앱 정상 실행 확인
- [ ] 테스트: 행정구역 데이터 로딩 확인

#### 1-2단계: monitoring_ui.py 분해 (1,129줄 → 3개 파일)
- [ ] 백업 생성: `monitoring_ui.py.backup`
- [ ] `monitoring_dashboard.py` (UI 컴포넌트)
- [ ] `monitoring_data.py` (데이터 처리 로직)
- [ ] `monitoring_charts.py` (차트 렌더링)
- [ ] 테스트: 모니터링 페이지 정상 동작 확인

### 🔧 2주차: 정리 - 중간 크기 파일들 정리
**목표**: 모든 서비스 파일 800줄 이하

#### 2-1단계: notification_service.py 분해 (972줄 → 3개 파일)
- [ ] 백업 생성
- [ ] `notification_sender.py` (알림 발송)
- [ ] `notification_scheduler.py` (스케줄링)
- [ ] `notification_config.py` (설정 관리)
- [ ] 테스트: 알림 기능 정상 동작 확인

#### 2-2단계: prompt_service.py 분해 (842줄 → 3개 파일)
- [ ] 백업 생성
- [ ] `prompt_manager.py` (프롬프트 CRUD)
- [ ] `prompt_renderer.py` (템플릿 렌더링)
- [ ] `prompt_validator.py` (프롬프트 검증)
- [ ] 테스트: 프롬프트 관리 기능 확인

### 📈 3주차: 개선 - 구조 최적화
**목표**: 코드 품질 향상 및 테스트 추가

#### 3-1단계: core 폴더 단순화
- [ ] 백업: `src/core` 전체 폴더
- [ ] 18개 파일 → 8-10개 핵심 파일로 정리
- [ ] 과도한 DI 패턴 단순화
- [ ] 테스트: 전체 앱 정상 실행 확인

#### 3-2단계: 기본 테스트 추가
- [ ] 빈 테스트 파일 정리
- [ ] 핵심 서비스 5개에 대한 기본 단위 테스트
- [ ] 테스트 실행 자동화 스크립트

### 🚀 4주차: 안정화 - 운영 편의성
**목표**: 장기 유지보수 편의성 확보

#### 4-1단계: 문서화 및 설정 정리
- [ ] 핵심 설정 방법 문서화
- [ ] 주요 서비스 간단한 API 문서
- [ ] 중복된 설정 파일 통합

#### 4-2단계: 기본 품질 관리
- [ ] 간단한 코드 포맷팅 적용 (black/ruff)
- [ ] 기본 로깅 표준화
- [ ] 간단한 헬스체크 기능

---

## 🛡️ 안전 조치 가이드

### 매 단계 필수 체크리스트
1. **변경 전**
   - [ ] Git 커밋으로 현재 상태 백업
   - [ ] 변경 대상 파일 `.backup` 복사본 생성
   - [ ] 앱 정상 실행 확인 및 스크린샷 저장

2. **변경 중**
   - [ ] 한 번에 하나의 파일만 수정
   - [ ] 변경 후 즉시 import 오류 체크
   - [ ] 변경 후 즉시 앱 실행 테스트

3. **변경 후**
   - [ ] 전체 앱 정상 실행 확인
   - [ ] 주요 기능별 동작 테스트
   - [ ] 오류 발생 시 즉시 백업에서 복원
   - [ ] 정상 동작 확인 후 Git 커밋

### 응급 복구 절차
```bash
# 백업에서 복원
cp file_name.py.backup file_name.py

# Git에서 복원 (마지막 정상 상태로)
git checkout HEAD~1 -- file_name.py
git reset --hard HEAD~1  # 전체 복원 (주의!)
```

---

## 📝 1주차 상세 실행 가이드

### Day 1: district_service.py 분석 및 분해 계획
1. **현재 상태 백업**
   ```bash
   git add . && git commit -m "리팩토링 시작 전 백업"
   cp src/services/district_service.py src/services/district_service.py.backup
   ```

2. **파일 분석**
   - 함수별 기능 분류
   - 의존성 관계 파악
   - 분해 지점 식별

3. **분해 계획 수립**
   - 각 새 파일의 책임 범위 정의
   - import 구조 설계
   - 테스트 시나리오 작성

### Day 2-3: district_service.py 실제 분해
1. **district_loader.py 생성**
   - 데이터 다운로드 기능
   - CSV/JSON 변환 기능
   - 기본 테스트 작성

2. **district_cache.py 생성**
   - 캐시 관리 로직
   - 캐시 무효화 정책
   - 성능 최적화 기능

3. **district_validator.py 생성**
   - 데이터 검증 로직
   - 무결성 체크
   - 에러 처리

4. **district_api.py 생성**
   - 외부 인터페이스
   - 기존 district_service.py의 public 메서드들
   - 하위 모듈들의 조합 로직

### Day 4: 통합 테스트 및 검증
1. **기능별 테스트**
   - 행정구역 데이터 로딩
   - 캐시 동작 확인
   - API 응답 검증

2. **전체 앱 테스트**
   - Streamlit 앱 정상 실행
   - 모든 페이지 정상 동작
   - 오류 로그 확인

### Day 5: monitoring_ui.py 분해 (동일한 패턴 적용)

---

## 🎯 성공 기준

### 정량적 목표
- [ ] 모든 Python 파일 500줄 이하
- [ ] 앱 시작 시간 2분 이내 유지
- [ ] 모든 기존 기능 100% 동작
- [ ] 새로운 에러나 경고 0개

### 정성적 목표
- [ ] 코드 이해하기 쉬워짐
- [ ] 새 기능 추가 시 수정 범위 예측 가능
- [ ] 버그 발생 시 원인 파악 시간 단축
- [ ] 1인 개발자가 3개월 후에도 코드 이해 가능

---

## ❌ 제외 사항 (현재는 하지 않음)

### 너무 복잡한 것들
- Domain-Driven Design 패턴
- 헥사고날/클린 아키텍처
- 복잡한 테스트 피라미드 (E2E, Integration 등)
- 마이크로서비스 분리
- 고급 CI/CD 파이프라인

### 당장 필요하지 않은 것들
- 성능 최적화
- 보안 강화 (현재 수준 유지)
- 다국어 지원
- 모바일 반응형
- 클라우드 배포 자동화

---

## 📚 참고 자료

### 리팩토링 체크리스트
- [x] 기존 기능 100% 보존
- [x] 코드 가독성 향상
- [x] 유지보수성 개선
- [x] 성능 저하 없음
- [x] 새로운 버그 도입 안함

### 응급 연락처
- 백업 파일 위치: `*.backup`
- Git 히스토리: `git log --oneline`
- 복원 명령어: `git checkout HEAD~1 -- filename`

---

**작성일**: 2025-09-21
**계획 기간**: 4주 (2025-09-21 ~ 2025-10-19)
**리뷰 주기**: 매주 금요일